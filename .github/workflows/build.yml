name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip openjdk-17-jdk build-essential git zip unzip wget libncurses5 libtool automake

    - name: Install Buildozer & dependencies
      run: |
        # Pin Cython to 0.29.x for pyjnius compatibility (Cython 3.0+ breaks old pyjnius)
        pip install "cython<3.0" buildozer packaging setuptools

    - name: Debug - Show buildozer.spec
      run: |
        echo "=== buildozer.spec contents ==="
        cat buildozer.spec
        echo ""
        echo "=== Checking android.accept_sdk_license ==="
        grep -i "accept_sdk" buildozer.spec || echo "NOT FOUND!"
    
    - name: Pre-build checks
      run: |
        echo "=== Checking Python syntax ==="
        python -m py_compile main.py && echo "✅ main.py syntax OK" || echo "❌ main.py syntax ERROR"
        
        echo ""
        echo "=== Checking source files ==="
        ls -la *.py 2>/dev/null || echo "No .py files in root"
        
        echo ""
        echo "=== Python imports test ==="
        python -c "import kivy; print('Kivy version:', kivy.__version__)" 2>&1 || echo "⚠️ Kivy not installed locally (expected)"

    - name: Cache buildozer downloads
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('**/*.py') }}-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: Build Android APK with real error capture
      timeout-minutes: 85
      run: |
        set -e
        set -o pipefail
        
        echo "=== Starting APK build ==="
        
        # Clean previous
        rm -rf bin/ .buildozer/android/app/build/ build.log
        
        # Show environment
        echo "=== Environment Check ==="
        python --version
        java -version 2>&1 || true
        buildozer --version 2>&1 || true
        echo "JAVA_HOME=$JAVA_HOME"
        echo "ANDROIDSDK=$ANDROIDSDK"
        echo "ANDROIDNDK=$ANDROIDNDK"
        
        # Run buildozer with verbose output and capture
        echo "=== Running buildozer android debug ==="
        buildozer -v android debug 2>&1 | tee build.log || {
          echo "❌ Buildozer failed! Showing last 100 lines of log:"
          tail -100 build.log || true
          exit 1
        }
        
        echo "=== Build step COMPLETED (buildozer finished) ==="
        ls -la bin/ 2>/dev/null || echo "No bin directory"

    - name: Find APK with aggressive search
      run: |
        echo "=== AGGRESSIVE APK SEARCH ==="
        
        # List all APK files found anywhere
        echo "--- All APK files in workspace ---"
        find . -name "*.apk" -type f 2>/dev/null | head -20 || echo "No APK in workspace"
        
        echo "--- All APK files in home ---"
        find ~ -name "*.apk" -type f 2>/dev/null | head -20 || echo "No APK in home"
        
        echo "--- buildozer bin/ directory ---"
        ls -la bin/ 2>/dev/null || echo "No bin/ directory"
        
        echo "--- .buildozer/android/ directories ---"
        ls -laR .buildozer/android/ 2>/dev/null | head -100 || echo "No build directory"
        
        # Try to find and copy APK
        APK_FILE=$(find . ~ -name "*.apk" -type f 2>/dev/null | head -1)
        if [ -n "$APK_FILE" ] && [ -f "$APK_FILE" ]; then
          echo "✅ Found APK: $APK_FILE"
          ls -lh "$APK_FILE"
          cp "$APK_FILE" ./app.apk
          echo "APK copied to ./app.apk"
        else
          echo "❌ NO APK FOUND!"
          exit 1
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: app.apk
        if-no-files-found: warn

    - name: Show build log on failure
      if: failure()
      run: |
        echo "=== FULL BUILD LOG (last 500 lines) ==="
        cat build.log | tail -500 2>/dev/null || echo "No build.log file"
