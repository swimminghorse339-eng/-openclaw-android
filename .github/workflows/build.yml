name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip openjdk-17-jdk build-essential git zip unzip wget libncurses5 libtool automake

    - name: Install Buildozer & dependencies
      run: |
        pip install buildozer cython packaging setuptools

    - name: Pre-setup Android SDK and accept licenses
      run: |
        echo "=== Setting up Android SDK and accepting ALL licenses ==="
        
        # This is where buildozer expects the SDK
        export ANDROID_SDK_HOME="$HOME/.buildozer/android/platform/android-sdk"
        mkdir -p "$ANDROID_SDK_HOME"
        cd "$ANDROID_SDK_HOME"
        
        # Download command line tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip
        
        # Create proper structure
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
        
        # Create the OLD directory structure buildozer expects
        mkdir -p tools/bin
        ln -sf "$ANDROID_SDK_HOME/cmdline-tools/latest/bin/sdkmanager" "$ANDROID_SDK_HOME/tools/bin/sdkmanager"
        
        # Add to PATH
        export PATH="$ANDROID_SDK_HOME/cmdline-tools/latest/bin:$ANDROID_SDK_HOME/tools/bin:$PATH"
        
        # Accept ALL licenses non-interactively (THIS IS KEY!)
        yes | sdkmanager --licenses || true
        
        # Also pre-populate the known license hashes
        mkdir -p "$ANDROID_SDK_HOME/licenses"
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > "$ANDROID_SDK_HOME/licenses/android-sdk-license"
        echo "84831b9409646a918e30573bab4c9c91346d8abd" > "$ANDROID_SDK_HOME/licenses/android-sdk-preview-license"
        echo "504667f4c0de7af1a5731f33b62b0b6fd6d7d0a5" > "$ANDROID_SDK_HOME/licenses/android-sdk-preview-license"
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> "$ANDROID_SDK_HOME/licenses/android-sdk-license"
        
        echo "=== SDK setup complete ==="
        echo "=== Licenses accepted: ==="
        ls -la "$ANDROID_SDK_HOME/licenses/"

    - name: Cache buildozer downloads
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('**/*.py') }}-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: Build Android APK
      timeout-minutes: 85
      run: |
        set -e
        set -o pipefail
        echo "=== Starting APK build ==="
        
        # Ensure buildozer can find SDK
        export ANDROID_SDK_HOME="$HOME/.buildozer/android/platform/android-sdk"
        export PATH="$ANDROID_SDK_HOME/tools/bin:$ANDROID_SDK_HOME/cmdline-tools/latest/bin:$PATH"
        
        # Clean previous
        rm -rf bin/ .buildozer/android/app/build/ build.log
        
        # Run buildozer with verbose output
        echo "=== Running buildozer android debug ==="
        buildozer -v android debug 2>&1 | tee build.log
        
        echo "=== Build step complete ==="

    - name: Find APK
      run: |
        echo "=== Searching for APK ==="
        
        APK_FILE=$(find . ~ -name "*.apk" -type f 2>/dev/null | head -1)
        
        if [ -n "$APK_FILE" ] && [ -f "$APK_FILE" ]; then
          echo "Found APK: $APK_FILE"
          ls -lh "$APK_FILE"
          cp "$APK_FILE" ./app.apk
        else
          echo "No APK found"
          ls -la bin/ 2>/dev/null || true
          ls -laR .buildozer/android/app/ 2>/dev/null | head -30 || true
          exit 1
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: app.apk
        if-no-files-found: error
