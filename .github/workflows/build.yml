name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip openjdk-17-jdk build-essential git zip unzip wget

    - name: Pre-install Android SDK for buildozer
      run: |
        echo "=== Installing Android SDK in buildozer's expected location ==="
        
        # This is where buildozer expects the SDK
        export ANDROID_SDK_HOME="$HOME/.buildozer/android/platform/android-sdk"
        mkdir -p "$ANDROID_SDK_HOME"
        cd "$ANDROID_SDK_HOME"
        
        # Download command line tools
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip
        
        # Create proper structure
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
        
        # Create the OLD directory structure buildozer expects
        # buildozer looks for sdkmanager in tools/bin/sdkmanager
        mkdir -p tools/bin
        ln -sf "$ANDROID_SDK_HOME/cmdline-tools/latest/bin/sdkmanager" "$ANDROID_SDK_HOME/tools/bin/sdkmanager"
        
        # Export for this step
        export PATH="$ANDROID_SDK_HOME/cmdline-tools/latest/bin:$ANDROID_SDK_HOME/tools/bin:$PATH"
        
        # Accept licenses non-interactively
        yes | sdkmanager --licenses || true
        
        # Install the basics buildozer needs
        sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.0"
        
        echo "=== SDK installed at: $ANDROID_SDK_HOME ==="
        echo "=== sdkmanager location: ==="
        which sdkmanager
        ls -la "$ANDROID_SDK_HOME/tools/bin/"
        echo "=== License files: ==="
        mkdir -p "$ANDROID_SDK_HOME/licenses"
        ls -la "$ANDROID_SDK_HOME/licenses/"

    - name: Install Buildozer & dependencies
      run: |
        pip install buildozer cython packaging setuptools

    - name: Cache buildozer downloads
      uses: actions/cache@v4
      with:
        path: ~/.buildozer
        key: ${{ runner.os }}-buildozer-${{ hashFiles('**/*.py') }}-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-buildozer-

    - name: Build Android APK
      timeout-minutes: 85
      run: |
        set -e
        echo "Starting APK build..."
        
        # Ensure buildozer can find sdkmanager
        export ANDROID_SDK_HOME="$HOME/.buildozer/android/platform/android-sdk"
        export PATH="$ANDROID_SDK_HOME/tools/bin:$ANDROID_SDK_HOME/cmdline-tools/latest/bin:$PATH"
        
        # Clean any previous attempts
        rm -rf bin/ .buildozer/android/app/build/ build.log
        
        # Run buildozer
        echo "=== Starting buildozer android debug ==="
        buildozer android debug 2>&1 | tee build.log
        
        echo "=== Build complete, searching for APK ==="

    - name: Find and verify APK
      run: |
        echo "=== Searching for APK ==="
        
        # Find APK in buildozer output locations
        APK_FILE=$(find . -name "*.apk" -type f 2>/dev/null | head -1)
        
        if [ -z "$APK_FILE" ]; then
            APK_FILE=$(find ~ -name "*.apk" -path "*/.buildozer/*" 2>/dev/null | head -1)
        fi
        
        if [ -n "$APK_FILE" ] && [ -f "$APK_FILE" ]; then
          echo "✅ Found APK: $APK_FILE"
          ls -lh "$APK_FILE"
          cp "$APK_FILE" ./app-debug.apk
          echo "APK copied to ./app-debug.apk"
        else
          echo "❌ NO APK FOUND!"
          echo "=== Listing bin/ directory ==="
          ls -la bin/ 2>/dev/null || echo "No bin/ directory"
          echo "=== build.log tail (last 100 lines) ==="
          tail -100 build.log || true
          exit 1
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: app-debug.apk
        if-no-files-found: error
