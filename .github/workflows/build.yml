name: Build Android APK on: push: branches: [ main, master ] pull_request: branches: [ main, master ] workflow_dispatch: jobs: build: runs-on: ubuntu-latest steps: - uses: actions/checkout@v4 - name: Set up Python uses: actions/setup-python@v5 with: python-version: '3.11' - name: Install dependencies run: | sudo apt-get update sudo apt-get install -y python3-pip openjdk-17-jdk sudo apt-get install -y build-essential libssl-dev libffi-dev python3-dev sudo apt-get install -y libgl1-mesa-dev libgles2-mesa-dev sudo apt-get install -y libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev sudo apt-get install -y libfreetype6-dev libpng-dev sudo apt-get install -y libx11-dev libxext-dev libxrender-dev libtiff5-dev sudo apt-get install -y libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev sudo apt-get install -y zlib1g-dev autoconf automake libtool - name: Setup Android SDK uses: android-actions/setup-android@v3 with: cmdline-tools-version: 12.0 packages: "platform-tools platforms;android-33 build-tools;36.1.0 ndk;25.2.9519653" accept-android-sdk-licenses: true - name: Setup SDK Manager for Buildozer run: | echo "ANDROID_HOME=$ANDROID_HOME" echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" # Create the tools/bin directory that buildozer expects mkdir -p $ANDROID_SDK_ROOT/tools/bin # Create wrapper script that points to actual sdkmanager cat > $ANDROID_SDK_ROOT/tools/bin/sdkmanager << 'EOF'
          #!/bin/bash
          exec $ANDROID_SDK_ROOT/cmdline-tools/12.0/bin/sdkmanager "$@"
          EOF
          chmod +x $ANDROID_SDK_ROOT/tools/bin/sdkmanager
          # Also check if sdkmanager is accessible
          which sdkmanager || echo "sdkmanager not in PATH, checking location..."
          find $ANDROID_SDK_ROOT -name "sdkmanager" -type f 2>/dev/null | head -5
          ls -la $ANDROID_SDK_ROOT/tools/bin/
          
      - name: Install Buildozer
        run: |
          pip install buildozer cython packaging
          
      - name: Create buildozer.spec
        run: |
          SDK_PATH="${ANDROID_SDK_ROOT:-$ANDROID_HOME}"
          echo "Using SDK path: $SDK_PATH"
          cat > buildozer.spec << EOF
          [app]
          title = Windows Remote
          package.name = windowsremote
          package.domain = com.example
          source.dir = .
          version = 0.1
          requirements = python3,kivy,requests,pyjnius,setuptools
          orientation = portrait
          fullscreen = 0
          android.archs = arm64-v8a
          android.permissions = INTERNET
          android.sdk_path = ${SDK_PATH}
          android.ndk_path = ${SDK_PATH}/ndk/25.2.9519653
          
          [buildozer]
          log_level = 2
          warn_on_root = 1
          EOF
          echo "=== buildozer.spec created ==="
          cat buildozer.spec
          
      - name: Build APK
        run: |
          echo "Starting build..."
          buildozer -v android debug 2>&1 | tee build_output.log
          result=$?
          echo "Build exit code: $result"
          cat build_output.log | tail -100
          exit $result
        timeout-minutes: 120
        
      - name: Collect artifacts
        if: always()
        run: |
          mkdir -p artifacts
          find . -name "*.apk" -o -name "*.aab" | xargs -I {} cp {} artifacts/ 2>/dev/null || true
          cp build_output.log artifacts/ 2>/dev/null || true
          ls -la artifacts/
          
      - name: Upload APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: artifacts/*
          if-no-files-found: warn