name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip
          sudo apt-get install -y build-essential libssl-dev libffi-dev python3-dev
          sudo apt-get install -y libgl1-mesa-dev libgles2-mesa-dev
          sudo apt-get install -y libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev
          sudo apt-get install -y libfreetype6-dev libpng-dev
          sudo apt-get install -y libx11-dev libxext-dev libxrender-dev libtiff5-dev
          sudo apt-get install -y libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev
          sudo apt-get install -y zlib1g-dev
          sudo apt-get install -y android-tools-adb
          sudo apt-get install -y autoconf automake libtool
          sudo apt-get install -y openjdk-17-jdk

      - name: Install Buildozer
        run: |
          pip install buildozer cython packaging

      - name: Show Buildozer Spec
        run: |
          cat buildozer.spec

      - name: Build APK
        run: |
          export ANDROIDAPI=33
          export ANDROIDNDK=25b
          buildozer android debug 2>&1 | tee build.log
        timeout-minutes: 90

      - name: Verify Build Output
        run: |
          echo "=== Build Output Check ==="
          ls -la bin/ 2>/dev/null || echo "No bin/ directory"
          find . -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
          echo "=== Buildozer Log ==="
          find .buildozer -name "*.log" -type f -exec cat {} \; 2>/dev/null | tail -100 || echo "No log files found"
          echo "=== Final Status ==="
          ls -la bin/*.apk 2>/dev/null

      - name: Upload APK
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            bin/*.apk
          if-no-files-found: warn
